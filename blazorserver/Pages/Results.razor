@page "/Results"
@using DataLibrary
@using blazorserver.Models
@using blazorserver.Components
@using Microsoft.Extensions.Configuration
@inject IDataAccess _data
@inject IConfiguration _config

<hr/>
<h2>Results</h2>

<MudGrid>
    <!-- CATEGORY -->
    <MudItem xs="10" sm="5" md="3">
        <MudSelect Label="Category" Placeholder="Select category" @bind-Value="SelectedCategory" OffsetY="true" Dense="true" Variant="Variant.Outlined" >
            <MudSelectItem Value=@("0")>All</MudSelectItem>
            <MudSelectItem Value=@("1")>Men's</MudSelectItem>
            <MudSelectItem Value=@("2")>Women's</MudSelectItem>
            <MudSelectItem Value=@("3")>Men's Indoor</MudSelectItem>
            <MudSelectItem Value=@("4")>Women's Indoor</MudSelectItem>
        </MudSelect>
    </MudItem>

    <!-- LEAGUE -->
    <MudItem xs="10" sm="5" md="3">
        <MudSelect Label="League" Placeholder="Select league" @bind-Value="SelectedLeague" OffsetY="true" Dense="true" Variant="Variant.Outlined">
            @foreach (var league in _leagues)
            {
                if (league.Hockey_Category_Id.ToString() == SelectedCategory || league.Hockey_Category_Id.ToString() == "0")
                {
                    <MudSelectItem Value=@(league)>@league.Name</MudSelectItem>
                }
            }
        </MudSelect>
    </MudItem>

    <!-- OPTIONAL: TEAM -->
    <MudItem xs="12" sm="6" md="4">
        <MudSelect Label="Team" Placeholder="Select team" @bind-Value="SelectedTeam" OffsetY="true" Dense="true" Variant="Variant.Outlined">
            @foreach (var team in _teams)
            {
                if (SelectedLeague != null && team.League_ID == SelectedLeague.Id)
                {
                    <MudSelectItem Value=@(team)>@team.Teamname</MudSelectItem>
                }
            }
        </MudSelect>
    </MudItem>

    <!-- SEARCH -->
    <MudIconButton Icon="@Icons.Material.Filled.Search" OnClick="SearchButton"></MudIconButton>
</MudGrid>

<hr/>
@if (_showResults)
{
    <MudGrid Class="d-flex justify-content-between">
        <MudPaper Elevation="0"><h3> Results</h3></MudPaper>
        <MudPaper Elevation="0">
            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ShowPrev" Disabled="@_hidePrev">Prev</MudButton>
            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ShowNext" Disabled="@_hideNext">Next</MudButton>
        </MudPaper>
    </MudGrid>
    if (_fixtures != null)
    {
        foreach (var fixture in _fixtures)
        {
            var team1Name = _teams.Single(x => x.Id == fixture.Team_1_ID).Teamname;
            var team2Name = _teams.Single(x => x.Id == fixture.Team_2_ID).Teamname;
            
            <FixtureCard Leagues="@_leagues" CurrentFixture="@fixture" TeamOneName="@team1Name" TeamTwoName="@team2Name"/>
        }
    }
}

@code {
    private string SelectedCategory { get; set; }
    private League SelectedLeague { get; set; }
    private Team SelectedTeam { get; set; }

    private List<Team> _teams;
    private List<League> _leagues;
    private List<Fixture> _fixtures;

    private int _offset;
    private const int Take = 10;
    private bool _hidePrev = true;
    private bool _hideNext;
    private int _fixtureCount;

    private bool _showResults;

    protected override async Task OnInitializedAsync()
    {
        _teams = await _data.LoadData<Team, dynamic>("SELECT * FROM Teams;", new {}, _config.GetConnectionString("default"));
        _leagues = await _data.LoadData<League, dynamic>("SELECT * FROM Leagues;", new {}, _config.GetConnectionString("default"));
    }

    private async Task SearchButton()
    {
        _showResults = true;
        _offset = 0;
        _hidePrev = true;
        await LoadFixturesAsync(SelectedCategory, SelectedLeague, SelectedTeam, _offset, Take);
        if (_fixtureCount <= Take) _hideNext = true;
    }

    private async Task LoadFixturesAsync(string category, League league, Team team, int offset, int take)
    {
        string sql, countSql;
        if (category is null or "0")
        {
            sql = $"SELECT * FROM Fixtures order by Date desc LIMIT {offset},{take};";
            countSql = $"SELECT COUNT(*) FROM Fixtures order by Date desc;";
        }
        else if (league == null)
        {
            sql = $"SELECT * FROM Fixtures WHERE Hockey_Category_ID = {category} order by Date desc LIMIT {offset},{take};";
            countSql = $"SELECT COUNT(*) FROM Fixtures WHERE Hockey_Category_ID = {category} order by Date desc;";
        }
        else if (team == null)
        {
            sql = $"SELECT * FROM Fixtures WHERE Hockey_Category_ID = {category} AND League_ID = {league.Id} order by Date desc LIMIT {offset},{take};";
            countSql = $"SELECT COUNT(*) FROM Fixtures WHERE Hockey_Category_ID = {category} AND League_ID = {league.Id} order by Date desc;";
        }
        else
        {
            sql = $"SELECT * FROM Fixtures WHERE Hockey_Category_ID = {category} AND League_ID = {league.Id} AND (Team_1_ID = {team.Id} OR Team_2_ID = {team.Id}) order by Date desc LIMIT {offset},{take};";
            countSql = $"SELECT COUNT(*) FROM Fixtures WHERE Hockey_Category_ID = {category} AND League_ID = {league.Id} AND (Team_1_ID = {team.Id} OR Team_2_ID = {team.Id}) order by Date desc;";
        }
        _fixtures = await _data.LoadData<Fixture, dynamic>(sql, new {}, _config.GetConnectionString("default"));
        _fixtureCount = await _data.LoadDataSingle<int, dynamic>(countSql, new {}, _config.GetConnectionString("default"));
    }

    private async Task ShowNext()
    {
        _offset += Take;
        if (_offset > _fixtureCount)
        {
            _offset = _fixtureCount;
            _hideNext = true;
            return;
        }
        await LoadFixturesAsync(SelectedCategory, SelectedLeague, SelectedTeam, _offset, Take);
        if (_offset > _fixtureCount - Take) _hideNext = true;
        if (_offset >= Take) _hidePrev = false;
    }

    private async Task ShowPrev()
    {
        _offset -= Take;
        if (_offset < 0)
        {
            _offset = 0;
            _hidePrev = true;
        }
        await LoadFixturesAsync(SelectedCategory, SelectedLeague, SelectedTeam, _offset, Take);
        if (_offset < Take)
        {
            _hidePrev = true;
        }
        _hideNext = false;
    }
}
